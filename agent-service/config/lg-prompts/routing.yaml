# State Machine Configuration for Routing Agent
# Simple routing logic to identify user intent and direct to appropriate specialist

# Global settings
settings:
  initial_state: "greet_and_identify_need"
  terminator_env_var: "AGENT_MESSAGE_TERMINATOR"
  agent_name: "routing-agent"
  terminal_state: "end"
  empty_response_retry_count: 5

# State structure definition
state_schema:
  business_fields:
    routing_decision:
      type: "string"
      default: null
      # Field to store the routing decision for session manager to detect

# State definitions
states:
  # State 1: Greet and Identify Need
  greet_and_identify_need:
    type: "llm_processor"
    temperature: 0.3
    failure_transition: "waiting_user_need"
    prompt: |
      You are a routing agent specializing in getting users to the correct specialist agent. Be helpful, friendly, and efficient in determining their needs.

      Greet the user and clearly identify yourself as the routing agent. Ask them what they need help with today.

      Currently you can help with:
      - Type-A application migration (OVA -> OpenShift Virtualization using MTV)

      Ask them to describe what they need help with.
    transitions:
      success: "waiting_user_need"

  # Waiting State: User describes their need
  waiting_user_need:
    type: "waiting"
    transitions:
      user_input: "classify_user_intent"

  # State 2: Classify User Intent
  # Uses intent_classifier for stricter label matching.
  classify_user_intent:
    type: "intent_classifier"
    temperature: 0.1  # Very deterministic for classification
    allowed_tools: [""]
    failure_transition: "waiting_user_need"
    intent_prompt: |
      The user said: "{user_input}"

      Classify this request into EXACTLY one category.
      Output ONLY the category label â€” no explanation, no reasoning.

      Categories:
      - TYPE_A_MIGRATION: ANY request involving migrating, moving, or transferring an application.
        This includes "migrate <app_name>", "app migration", "migration", "migrate payments",
        "migrate my service", or mentioning MTV / OpenShift Virtualization / KubeVirt.
        If the user mentions "migrate" + anything, classify as TYPE_A_MIGRATION.
      - OTHER: does not fit the category above

      Respond with ONLY one word: TYPE_A_MIGRATION or OTHER
    intent_actions:
      TYPE_A_MIGRATION:
        response: "type-a-app-migration"
        data_storage:
          routing_decision: "type-a-app-migration"
        next_state: "end"
      OTHER:
        next_state: "handle_other_request"

  # State 3: Handle Other/Unclear Requests
  handle_other_request:
    type: "llm_processor"
    temperature: 0.3
    failure_transition: "waiting_clarification"
    prompt: |
      The user said: "{last_user_message}"

      Their request doesn't clearly match our available services. Politely explain that you can currently help with:
      - Type-A application migration (OVA -> OpenShift Virtualization using MTV)

      Ask them to clarify if they need help with application migration, or let them know you cannot help with their specific request.

      Be helpful and professional.
    transitions:
      success: "waiting_clarification"

  # Waiting State: User clarifies their need
  # Loops back to classify so the user's clarification is actually
  # re-classified instead of discarded.
  waiting_clarification:
    type: "waiting"
    transitions:
      user_input: "classify_user_intent"

  # End state
  end:
    type: "terminal"
    # No reset_behavior - routing agent should not auto-reset
    # Session manager will handle routing to specialist agent or create new session if needed
